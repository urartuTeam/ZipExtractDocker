# Организационная структура компании

Веб-приложение для управления организационной структурой компании, проектами и отпусками сотрудников.

## Содержание

- [Технический стек](#технический-стек)
- [Функциональность](#функциональность)
- [Запуск приложения](#запуск-приложения)
- [Инициализация базы данных](#инициализация-базы-данных)
- [Управление базой данных](#управление-базой-данных)
- [Тестирование API](#тестирование-api)
- [Особенности и важные моменты](#особенности-и-важные-моменты)

## Технический стек

- **Фронтенд**: React, TypeScript, Shadcn UI, React Query
- **Бэкенд**: Express.js с TypeScript
- **База данных**: PostgreSQL с Drizzle ORM
- **Валидация**: Zod
- **Аутентификация**: JWT, локальная стратегия

## Функциональность

- Управление организационной структурой (отделы, должности, сотрудники)
- Иерархическое отображение структуры компании
- Управление проектами и назначение сотрудников
- Учет отпусков сотрудников
- Управление вакансиями
- Разделение интерфейса для обычных пользователей и администраторов

## Запуск приложения

Для запуска приложения используется workflow "Start application", который запускает команду `npm run dev`:

```bash
npm run dev
```

## Инициализация базы данных

Для инициализации базы данных можно использовать скрипт `init_database.sh`:

```bash
./init_database.sh
```

Этот скрипт последовательно выполняет следующие операции:
1. Создание структуры базы данных (`database_init.sql`)
2. Вставка начальных данных (`database_insert_data.sql`)
3. Настройка механизма soft delete (`add_soft_delete.sql`)
4. Обновление последовательностей (`fix_sequences.sql`)

## Управление базой данных

### Исправление последовательностей

Если возникают проблемы с автоинкрементом ID в таблицах, используйте скрипт `fix_sequences.sh`:

```bash
./fix_sequences.sh
```

### Настройка полей вакансий

Для добавления и настройки полей учета вакансий используйте SQL-скрипт:

```bash
psql "$DATABASE_URL" -f add_vacancy_fields_to_position_department.sql
```

## Тестирование API

Для проверки работоспособности API используйте скрипт `test_api.sh`:

```bash
./test_api.sh
```

Этот скрипт выполняет следующие тесты:
1. Получение данных из всех основных таблиц
2. Создание тестовых записей (отдел, должность, сотрудник)
3. Обновление созданных записей
4. Удаление созданных записей (soft delete)

## Особенности и важные моменты

### Soft Delete

Все операции удаления реализованы как "мягкое удаление" (soft delete). При удалении записи:
- Поле `deleted` устанавливается в `true`
- Поле `deleted_at` заполняется текущей датой и временем
- Запись физически остается в базе данных
- При получении данных через API учитываются только записи с `deleted=false`

### Вакансии

Вакансии автоматически рассчитываются как разница между штатными единицами (`staff_units`) и текущим количеством (`current_count`). Для этого используется триггер PostgreSQL, который автоматически обновляет поле `vacancies`.

### Структура организации

Организационная структура строится по следующим правилам:
- Отделы могут иметь родительский отдел (parent_department_id) или родительскую должность (parent_position_id), но не оба одновременно
- Корневые отделы имеют null в обоих полях parent_department_id и parent_position_id
- Должности могут иметь родительскую должность (parent_position_id)
- Связь между должностями и отделами осуществляется через таблицу position_department